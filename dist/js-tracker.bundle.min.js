import e from"@xapi/xapi";import{v4 as t}from"uuid";import s from"axios";import i from"ms";class n{constructor(e,t){this.accountName=e,this.homepage=t}accountName;homepage;toXAPI(){return{account:{name:this.accountName,homePage:this.homepage}}}toCSV(){return this.accountName.replaceAll(",","\\,")}}class a{constructor(e="seriousgame",s=null){this.registration=null!=s?s:t(),this.categoryId=this.categoryIDs[e],this.category=e}registration;categoryIDs={seriousgame:"https://w3id.org/xapi/seriousgame",scorm:"https://w3id.org/xapi/scorm"};toXAPI(){return{registration:this.registration,contextActivities:{category:[{id:this.categoryId,definition:{type:"http://adlnet.gov/expapi/activities/profile"}}]}}}toCSV(){return this.registration.replaceAll(",","\\,")}}class r{constructor(e){this.verbId=this.verbIds[e],this.verbDisplay=e}verbIds={initialized:"http://adlnet.gov/expapi/verbs/initialized",progressed:"http://adlnet.gov/expapi/verbs/progressed",completed:"http://adlnet.gov/expapi/verbs/completed",accessed:"https://w3id.org/xapi/seriousgames/verbs/accessed",skipped:"http://id.tincanapi.com/verb/skipped",selected:"https://w3id.org/xapi/adb/verbs/selected",unlocked:"https://w3id.org/xapi/seriousgames/verbs/unlocked",interacted:"http://adlnet.gov/expapi/verbs/interacted",used:"https://w3id.org/xapi/seriousgames/verbs/used",responded:"http://adlnet.gov/expapi/verbs/responded",resumed:"http://adlnet.gov/expapi/verbs/resumed",suspended:"http://adlnet.gov/expapi/verbs/suspended",terminated:"http://adlnet.gov/expapi/verbs/resumed",passed:"http://adlnet.gov/expapi/verbs/passed",failed:"http://adlnet.gov/expapi/verbs/failed",scored:"http://adlnet.gov/expapi/verbs/scored"};verbId;verbDisplay;toXAPI(){var e={};return this.verbId&&(e.id=this.verbId),this.verbDisplay&&(e.display={en:this.verbDisplay}),e}toCSV(){return this.verbId}}class o{constructor(e,t,s=null,i=null){this.id=e,this.type=t,this.name=s,this.description=i}typeIds={game:"https://w3id.org/xapi/seriousgames/activity-types/serious-game",session:"https://w3id.org/xapi/seriousgames/activity-types/session",level:"https://w3id.org/xapi/seriousgames/activity-types/level",quest:"https://w3id.org/xapi/seriousgames/activity-types/quest",stage:"https://w3id.org/xapi/seriousgames/activity-types/stage",combat:"https://w3id.org/xapi/seriousgames/activity-types/combat",storynode:"https://w3id.org/xapi/seriousgames/activity-types/story-node",race:"https://w3id.org/xapi/seriousgames/activity-types/race",completable:"https://w3id.org/xapi/seriousgames/activity-types/completable",screen:"https://w3id.org/xapi/seriousgames/activity-types/screen",area:"https://w3id.org/xapi/seriousgames/activity-types/area",zone:"https://w3id.org/xapi/seriousgames/activity-types/zone",cutscene:"https://w3id.org/xapi/seriousgames/activity-types/cutscene",accessible:"https://w3id.org/xapi/seriousgames/activity-types/accessible",question:"http://adlnet.gov/expapi/activities/question",menu:"https://w3id.org/xapi/seriousgames/activity-types/menu",dialog:"https://w3id.org/xapi/seriousgames/activity-types/dialog-tree",path:"https://w3id.org/xapi/seriousgames/activity-types/path",arena:"https://w3id.org/xapi/seriousgames/activity-types/arena",alternative:"https://w3id.org/xapi/seriousgames/activity-types/alternative",enemy:"https://w3id.org/xapi/seriousgames/activity-types/enemy",npc:"https://w3id.org/xapi/seriousgames/activity-types/non-player-character",item:"https://w3id.org/xapi/seriousgames/activity-types/item",gameobject:"https://w3id.org/xapi/seriousgames/activity-types/game-object",course:"http://adlnet.gov/expapi/activities/course",module:"http://adlnet.gov/expapi/activities/module",SCO:"http://adlnet.gov/expapi/activities/lesson",assessment:"http://adlnet.gov/expapi/activities/assessment",interaction:"http://adlnet.gov/expapi/activities/interaction",cmi_interaction:"http://adlnet.gov/expapi/activities/cmi.interaction",objective:"http://adlnet.gov/expapi/activities/objective",attempt:"http://adlnet.gov/expapi/activities/attempt",profile:"http://adlnet.gov/expapi/activities/profile"};ExtensionIDs={extended_interaction_type:"https://w3id.org/xapi/netc-assessment/extensions/activity/extended-interaction-type"};id;type;name;description;toXAPI(){var e={};return this.id&&(e.id=this.id),e.definition={},this.name&&(e.definition.name={"en-US":this.name}),this.description&&(e.definition.description={"en-US":this.description}),this.type&&(e.definition.type=this.typeIds[this.type]),e}toCSV(){return this.typeIds[this.type].replaceAll(",","\\,")+","+this.id.replaceAll(",","\\,")}}class h{constructor(e){this.defautURI=e,this.Score=null,this.Success=null,this.Completion=null,this.Response=null,this.Duration=null,this.Extensions={}}defautURI;Score;Success;Completion;Response;Duration;Extensions;isEmpty(){return null==this.Score&&null==this.Duration&&null==this.Success&&null==this.Completion&&null==this.Response&&0==Object.keys(this.Extensions).length}ExtensionIDs={health:"https://w3id.org/xapi/seriousgames/extensions/health",position:"https://w3id.org/xapi/seriousgames/extensions/position",progress:"https://w3id.org/xapi/seriousgames/extensions/progress",interactionID:"https://w3id.org/xapi/netc-assessment/extensions/activity/id-number",response_explanation:"https://w3id.org/xapi/netc-assessment/extensions/result/response-explanation",response_type:"https://w3id.org/xapi/netc-assessment/extensions/result/response-type"};ScoreKey=["raw","min","max","scaled"];setExtensions(e){for(var t in this.Extensions={},e)this.setExtension(t,e[t])}setExtension(e,t){switch(e.toLowerCase()){case"success":this.Success=t;break;case"completion":this.Completion=t;break;case"response":this.Response=t;break;case"score":this.Score=this.setScoreValue("raw",t);break;case"duration":this.Duration=t;break;default:this.Extensions[e]=t}}setAsUri(e){return this.isUri(e)?e:`${this.defautURI}://${e}`}isUri(e){return/^[a-zA-Z][a-zA-Z\d+\-.]*:\/\/[^\s/$.?#].[^\s]*$/i.test(e)}setScoreValue(e,t){this.Score||(this.Score={}),this.ScoreKey.includes(e)&&(this.Score[e]=Number(t))}toXAPI(){var e={};if(null!==this.Success&&(e.success=!!this.Success),null!==this.Completion&&(e.completion=!!this.Completion),this.Response&&(e.response=this.Response.toString()),null!==this.Score&&(e.score=this.Score),null!==this.Duration&&(e.duration=this.Duration),null!==this.Extensions&&c(this.Extensions)>0)for(var t in e.extensions=this.Extensions,this.Extensions)if(this.ExtensionIDs.hasOwnProperty(t))this.Extensions[this.ExtensionIDs[t]]=this.Extensions[t],delete this.Extensions[t];else{var s=this.setAsUri(t);this.Extensions[s]=this.Extensions[t],s!==t&&delete this.Extensions[t]}return e}toCSV(){var e=null!==this.Success?",success,"+this.Success.toString():"",t=null!==this.Completion?",completion,"+this.Completion.toString():"",s=this.Response?",response,"+this.Response.replaceAll(",","\\,"):"",i="";u(this.Score)&&(u(this.Score.raw)&&(i+=",score,"+this.Score.raw),u(this.Score.min)&&(i+=",score_min,"+this.Score.min),u(this.Score.max)&&(i+=",score_max,"+this.Score.max),u(this.Score.scaled)&&(i+=",score_scaled,"+this.Score.scaled));var n=e+t+s+i;if(null!==this.Extensions&&c(this.Extensions)>0)for(var a in this.Extensions)if(n+=","+a.replaceAll(",","\\,")+",",null!==this.Extensions[a])if("number"==typeof this.Extensions[a])n+=this.Extensions[a];else if("string"==typeof this.Extensions[a])n+=this.Extensions[a].replaceAll(",","\\,");else if("object"==typeof this.Extensions[a]){if(l(this.Extensions[a])){var r="";for(var o in this.Extensions[a])"number"==typeof this.Extensions[a][o]?r+=o+"="+this.Extensions[a][o]+"-":r+=o+"="+this.Extensions[a][o].replaceAll(",","\\,")+"-";n+=r.slice(0,-1)}}else n+=this.Extensions[a];return n}}var c=function(e){var t,s=0;for(t in e)e.hasOwnProperty(t)&&s++;return s},l=function(e){for(var t in e)if("object"==typeof e[t])return!1;return!0},u=function(e){return!(null==e)};class d{constructor(e,s,i,n,a,c){this.id=t(),this.actor=e,this.verb=new r(s),this.defaultURI=c,this.object=new o(this.setAsUri(i),n),this.timestamp=new Date,this.context=a,this.version="1.0.3",this.result=new h(this.defaultURI)}id;version;defaultURI;actor;verb;object;timestamp;context;result;setAsUri(e){return this.isUri(e)?e:`${this.defaultURI}://${e}`}isUri(e){return/^[a-zA-Z][a-zA-Z\d+\-.]*:\/\/[^\s/$.?#].[^\s]*$/i.test(e)}setScore(e,t,s,i){e&&this.setScoreRaw(e),t&&this.setScoreMin(t),s&&this.setScoreMax(s),i&&this.setScoreScaled(i)}setScoreRaw(e){this.result.setScoreValue("raw",e)}setScoreMin(e){this.result.setScoreValue("min",e)}setScoreMax(e){this.result.setScoreValue("max",e)}setScoreScaled(e){this.result.setScoreValue("scaled",e)}setCompletion(e){this.addResultExtension("completion",e)}setSuccess(e){this.addResultExtension("success",e)}setDuration(e,t){const s=(t.getTime()-e.getTime())/1e3,i=s%60,n=Math.floor(s/60)%60,a=Math.floor(s/3600)%24,r=`P${Math.floor(s/86400)}DT${a}H${n}M${i}S`;this.addResultExtension("duration",r)}setResponse(e){this.addResultExtension("response",e)}setProgress(e){this.addResultExtension("progress",e)}setVar(e,t){this.addResultExtension(e,t)}addResultExtension(e,t){this.result.setExtension(e,t)}addResultExtensions(e){this.result.setExtensions(e)}toXAPI(){var e={};return this.id&&(e.id=this.id),this.actor&&(e.actor=this.actor.toXAPI()),this.verb&&(e.verb=this.verb.toXAPI()),this.object&&(e.object=this.object.toXAPI()),this.timestamp&&(e.timestamp=this.timestamp.toISOString()),this.context&&(e.context=this.context.toXAPI()),this.version&&(e.version=this.version),this.result.isEmpty()||(e.result=this.result.toXAPI()),e}toCSV(){var e=[];e.push(this.timestamp.toISOString()),e.push(this.verb.toCSV()),e.push(this.object.toCSV());var t="";return this.result.isEmpty()||(t=this.result.toCSV()),`${e.join(",")}${t}`}}class p{client;statement;_promise;constructor(e,t){this.client=e,this.statement=t,this._promise=Promise.resolve().then((()=>this.client.enqueue(this.statement)))}withSuccess(e){return this.statement.setSuccess(e),this}withScore(e){return this.statement.setScore(e.raw??e?.raw,e.min??e?.min,e.max??e?.max,e.scaled??e?.scaled),this}withScoreRaw(e){return this.statement.setScoreRaw(e),this}withScoreMin(e){return this.statement.setScoreMin(e),this}withScoreMax(e){return this.statement.setScoreMax(e),this}withScoreScaled(e){return this.statement.setScoreScaled(e),this}withCompletion(e){return this.statement.setCompletion(e),this}withDuration(e,t){return this.statement.setDuration(e,t),this}withResponse(e){return this.statement.setResponse(e),this}withProgress(e){return this.statement.setProgress(e),this}withResultExtension(e,t){return this.statement.addResultExtension(e,t),this}withResultExtensions(e={}){return this.statement.addResultExtensions(e),this}apply(e){const t=e(this.statement);return t instanceof d&&(this.statement=t),this}then(e,t){return this._promise.then(e,t)}catch(e){return this._promise.catch(e)}finally(e){return this._promise.finally(e)}}class m{xapi=null;endpoint;auth_token=null;online=!1;statementsToSend=[];sendingInProgress=!1;offset=0;backup=!1;backup_endpoint=null;backup_type=null;backupRequestParameters=null;actor;actor_homePage;actor_name;context;default_uri;debug;batchlength;batchtimeout;retryDelay=null;maxRetryDelay;timer=null;constructor({endpoint:e,actor_homePage:t,actor_name:s,default_uri:r=null,backup_endpoint:o=null,backup_type:h="XAPI",auth_token:c=null,debug:l=!1,batchLength:u=null,batchTimeout:d=null,maxRetryDelay:p=null}){this.default_uri=r,this.debug=l,this.online=!1,this.endpoint=e,o&&(this.backup=!0,this.backup_type=h,this.backup_endpoint=o),this.batchlength=u||100,this.batchtimeout=i(d||"30sec"),this.offset=0,this.maxRetryDelay=i(p||"2min"),this.statementsToSend=[],this.timer=null,this.auth_token=c,this.actor_homePage=t,this.actor_name=s,this.actor=new n(this.actor_name,this.actor_homePage),this.context=new a,this.updateAuth()}logout(){this.auth_token=null,this.onOffline()}onOffline(){this.online=!1,this.debug&&console.warn("XAPI Tracker for Serious Games went offline")}async onOnline(){this.online=!0,this.debug&&console.info("XAPI Tracker for Serious Games back Online")}updateAuth(){null!=this.auth_token?(this.xapi=new e({endpoint:this.endpoint,auth:this.auth_token}),null!=this.xapi?this.onOnline():this.onOffline()):this.onOffline()}async sendBatch(){if(!this.online)return;if(this.offset>=this.statementsToSend.length)return;const e=Math.min(this.offset+this.batchlength,this.statementsToSend.length),t=this.statementsToSend.slice(this.offset,e),s=t.map((e=>e.toXAPI()));try{if(!this.sendingInProgress){this.sendingInProgress=!0;const e=await this.xapi.sendStatements({statements:s});this.sendingInProgress=!1,this.debug&&console.debug("Batch sent successfully:",e),this.offset+=t.length,this.retryDelay=null}}catch(e){console.error("Error sending batch:",e.response);const t=e.response.status,s=e.response.data.message||e.message;switch(t){case 401:case 403:console.error(`${401===t?"Unauthorized":"Forbidden"}: ${s}`),this.onOffline(),await this.refreshAuth(),this.sendingInProgress=!1,await this.sendBatch();break;default:console.error(`[TRACKER: Batch Processor] Batch upload returned status ${t} with message: ${s}`),this.sendingInProgress=!1,this.onOffline()}null==this.retryDelay&&(this.retryDelay=this.batchtimeout),this.retryDelay=Math.min(2*this.retryDelay,this.maxRetryDelay),this.timer=null}this.offset<this.statementsToSend.length&&this.startTimer()}async refreshAuth(){this.updateAuth()}startTimer(){if(this.timer)return;let e=this.retryDelay?this.retryDelay:this.batchtimeout;this.timer=setTimeout((async()=>{await this.sendBatch(),this.timer=null,this.offset<this.statementsToSend.length&&this.startTimer()}),e)}Trace(e,t,s){const i=new d(this.actor,e,s,t,this.context,this.default_uri);return new p(this,i)}async sendBackup(){if(this.online&&this.backup_endpoint&&this.backup_endpoint.trim()){let e,t;switch(this.backup_type){case"XAPI":t=this.statementsToSend.map((e=>JSON.stringify(e.toXAPI()))),e="application/json";break;case"CSV":t=this.statementsToSend.map((e=>e.toCSV())),e="text/csv";break;default:return}const i={tofile:!0,result:t.join("\n"),contentType:e},n={url:this.backup_endpoint,method:"POST",headers:{Authorization:this.auth_token||"","Content-Type":"application/json"},data:JSON.stringify(i,null,2)};if(this.backupRequestParameters&&(this.backupRequestParameters.content_type&&(n.headers["Content-Type"]=this.backupRequestParameters.content_type),this.backupRequestParameters.headers&&"object"==typeof this.backupRequestParameters.headers&&Object.entries(this.backupRequestParameters.headers).forEach((([e,t])=>{n.headers[e]=t})),this.backupRequestParameters.query_parameters&&"object"==typeof this.backupRequestParameters.query_parameters)){const e=new URLSearchParams(this.backupRequestParameters.query_parameters).toString();n.url+=`?${e}`}try{const e=await s(n);console.log(e)}catch(e){if(!e.response)throw new Error(`Request failed: ${e.message}`);{const t=e.response.status,s=e.response.data.message||e.message;switch(t){case 401:case 403:this.onOffline(),console.error(`${401===t?"Unauthorized":"Forbidden"}: ${s}`),await this.refreshAuth(),await this.sendBackup();break;default:console.error(`[TRACKER: Backup Processor] Backup upload returned status ${t} with message: ${s}`)}}}}}async enqueue(e){this.debug&&(console.debug(e.toXAPI()),console.debug(e.toCSV())),this.statementsToSend.push(e),this.online&&this.statementsToSend.length>=this.offset+this.batchlength&&await this.sendBatch(),this.startTimer()}async flush({withBackup:e=!1}={}){e?await Promise.all([this.sendBatch(),this.sendBackup()]):await this.sendBatch()}}class g extends m{constructor({endpoint:t,actor_homePage:s,actor_name:i,default_uri:n,username:a,password:r,backup_endpoint:o=null,backup_type:h="XAPI",debug:c=null,batchLength:l=null,batchTimeout:u=null,maxRetryDelay:d=null}){super({endpoint:t,backup_endpoint:o,backup_type:h,actor_homePage:s,actor_name:i,auth_token:e.toBasicAuth(a,r),default_uri:n,debug:c,batchLength:l,batchTimeout:u,maxRetryDelay:d}),window.addEventListener("beforeunload",(()=>{this.auth_token&&this.logout()}))}async refreshAuth(){super.refreshAuth()}logout(){super.logout()}}class y{fieldMissingMessage;unsupportedGrantTypeMessage;unsupportedCodeChallengeMethodMessage;authEndpoint=null;tokenEndpoint=null;grantType=null;username=null;password=null;clientId=null;scope=null;state=null;login_hint=null;codeChallengeMethod=null;token=null;tokenRefreshInProgress=!1;onAuthorizationInfoUpdate=null;constructor(){this.fieldMissingMessage='Field "{0}" required for "OAuth 2.0" authentication is missing!',this.unsupportedGrantTypeMessage='Grant type "{0}" not supported. Please use either "code" type or "password" type.',this.unsupportedCodeChallengeMethodMessage='Code challenge (PKCE) method "{0}" not supported. Please use "S256" method or disable it.'}async init(e){if(console.log("[OAuth2] Starting"),this.tokenEndpoint=this.getRequiredValue(e,"token_endpoint"),this.grantType=this.getRequiredValue(e,"grant_type").toLowerCase(),this.clientId=this.getRequiredValue(e,"client_id"),this.scope=e.scope||null,this.state=e.state||null,e.code_challenge_method){const t=e.code_challenge_method.toUpperCase();if("S256"!==t)throw new Error(this.unsupportedCodeChallengeMethodMessage.replace("{0}",t));this.codeChallengeMethod="S256"}switch(this.grantType){case"refresh_token":const t=this.getRequiredValue(e,"refresh_token");this.token=await this.doRefreshToken(this.tokenEndpoint,this.clientId,t);break;case"password":this.username=this.getRequiredValue(e,"username"),this.password=this.getRequiredValue(e,"password"),this.login_hint=this.getRequiredValue(e,"login_hint"),this.token=await this.doResourceOwnedPasswordCredentialsFlow(this.tokenEndpoint,this.clientId,this.username,this.password,this.login_hint,this.scope,this.state);break;default:throw new Error(this.unsupportedGrantTypeMessage.replace("{0}",this.grantType))}this.token&&console.log("[OAuth2] Token obtained: "+this.token.access_token)}getRequiredValue(e,t){if(!e[t])throw new Error(this.fieldMissingMessage.replace("{0}",t));return e[t]}async doResourceOwnedPasswordCredentialsFlow(e,t,s,i,n,a,r){const o={username:s,password:i,login_hint:n};return a&&(o.scope=a),r&&(o.state=r),await this.doTokenRequest(e,t,"password",o)}async doTokenRequest(e,t,s,i){const n={grant_type:s,client_id:t,...i};try{const t=await fetch(e,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams(n)});return await t.json()}catch(e){throw e.response&&e.response.data?new Error(e.response.data.error||"Error during token request"):e}}async doRefreshToken(e,t,s){return await this.doTokenRequest(e,t,"refresh_token",{refresh_token:s})}async refreshToken(){if(0==this.tokenRefreshInProgress)try{return this.tokenRefreshInProgress=!0,this.token=await this.doRefreshToken(this.tokenEndpoint,this.clientId,this.token.refresh_token),this.tokenRefreshInProgress=!1,this.token.access_token}catch(e){this.tokenRefreshInProgress=!1,console.error(e)}else for(;1==this.tokenRefreshInProgress;)await new Promise((e=>setTimeout(e,2e3)))}hasTokenExpired(){return new Date(this.token.requestTime.getTime()+1e3*this.token.expires_in)>new Date}async updateParamsForAuth(e){this.hasTokenExpired()&&(this.token=await this.doRefreshToken(this.tokenEndpoint,this.clientId,this.token.refresh_token),this.onAuthorizationInfoUpdate&&this.onAuthorizationInfoUpdate(this.token)),e.headers={...e.headers,Authorization:`${this.token.token_type.charAt(0).toUpperCase()+this.token.token_type.slice(1)} ${this.token.access_token}`}}registerAuthInfoUpdate(e){e&&(this.onAuthorizationInfoUpdate=e,this.token&&e(this.token))}async logout(){const e={grant_type:"refresh_token",client_id:this.clientId,refresh_token:this.token.refresh_token};try{const t=await fetch(this.tokenEndpoint.replace("/token","/logout"),{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams(e)}),s=await t.json();console.log(s),console.log("[OAuth2] Logged out successfully")}catch(e){throw e.response&&e.response.data?new Error(e.response.data.error||"[OAuth2] Error during logout"):e}}}class b extends m{oauth2Config;oauth2=null;constructor({endpoint:e,actor_homePage:t,actor_name:s,config:i,default_uri:n,backup_endpoint:a=null,backup_type:r="XAPI",debug:o=!1,batchLength:h=null,batchTimeout:c=null,maxRetryDelay:l=null}){super({endpoint:e,backup_endpoint:a,backup_type:r,actor_homePage:t,actor_name:s,default_uri:n,debug:o,batchLength:h,batchTimeout:c,maxRetryDelay:l}),this.oauth2Config=i,this.oauth2=null,this.initAuth(),window.addEventListener("beforeunload",(()=>{this.auth_token&&this.logout()}))}async getToken(){try{return this.oauth2=new y,await this.oauth2.init(this.oauth2Config),this.oauth2.token.access_token}catch(e){return console.error(e),null}}async initAuth(){const e=await this.getToken();null!==e&&(this.auth_token="Bearer "+e,console.debug(this.auth_token),this.updateAuth())}async refreshAuth(){const e=await this.oauth2.refreshToken();e&&(this.auth_token="Bearer "+e,console.debug(this.auth_token),this.updateAuth())}updateAuth(){super.updateAuth()}async logout(){await this.oauth2.logout(),super.logout()}}class f{constructor(e,t,s=w.ACCESSIBLE){this.accessibleId=t,this.type=s,this.tracker=e}accessibleId;type;tracker;AccessibleType=["screen","area","zone","cutscene","accessible"];Accessed(){return this.tracker.Trace("accessed",this.AccessibleType[this.type],this.accessibleId)}Skipped(){return this.tracker.Trace("skipped",this.AccessibleType[this.type],this.accessibleId)}}const w=Object.freeze({SCREEN:0,AREA:1,ZONE:2,CUTSCENE:3,ACCESSIBLE:4});class k{constructor(e,t,s=_.COMPLETABLE){this.completableId=t,this.type=s,this.tracker=e}completableId;type;tracker;CompletableType=["game","session","level","quest","stage","combat","storynode","race","completable"];initialized=!1;initializedTime;Initialized(){var e=!0;if(this.initializedTime){if(this.tracker.debug)throw new Error("The initialized statement for the specified id has already been sent!");console.warn("The initialized statement for the specified id has already been sent!"),e=!1}return e&&(this.initializedTime=new Date,this.initialized=!0),this.tracker.Trace("initialized",this.CompletableType[this.type],this.completableId)}Progressed(e){return this.tracker.Trace("progressed",this.CompletableType[this.type],this.completableId).withProgress(e)}Completed(e,t,s){if(void 0===e&&(e=!0),void 0===t&&(t=!1),void 0===s&&(s=1),!this.initialized){if(this.tracker.debug)throw new Error("You need to send a initialized statement before sending an Completed statement!");return void console.warn("You need to send a initialized statement before sending an Completed statement!")}let i=new Date;return this.initialized=!1,this.tracker.Trace("completed",this.CompletableType[this.type],this.completableId).withSuccess(e).withCompletion(t).withScore({raw:s}).withDuration(this.initializedTime,i)}}const _=Object.freeze({GAME:0,SESSION:1,LEVEL:2,QUEST:3,STAGE:4,COMBAT:5,STORYNODE:6,RACE:7,COMPLETABLE:8});class x{constructor(e,t,s=S.ALTERNATIVE){this.alternativeId=t,this.type=s,this.tracker=e}alternativeId;type;tracker;AlternativeType=["question","menu","dialog","path","arena","alternative"];Selected(e){return this.tracker.Trace("selected",this.AlternativeType[this.type],this.alternativeId).withResponse(e)}Unlocked(e){return this.tracker.Trace("unlocked",this.AlternativeType[this.type],this.alternativeId).withResponse(e)}}const S=Object.freeze({QUESTION:0,MENU:1,DIALOG:2,PATH:3,ARENA:4,ALTERNATIVE:5});class T{constructor(e,t,s=v.GAMEOBJECT){this.gameobjectId=t,this.type=s,this.tracker=e}gameobjectId;type;tracker;GameObjectType=["enemy","npc","item","gameobject"];Interacted(){return this.tracker.Trace("interacted",this.GameObjectType[this.type],this.gameobjectId)}Used(){return this.tracker.Trace("used",this.GameObjectType[this.type],this.gameobjectId)}}const v=Object.freeze({ENEMY:0,NPC:1,ITEM:2,GAMEOBJECT:3});class E{constructor(e,t,s=I.SCO){this.scormId=t,this.type=s,this.tracker=e}accessibleId;type;tracker;ScormType=["SCO","course","module","assessment","interaction","objective","attempt"];initialized=!1;initializedTime;Initialized(){var e=!0;if(this.initialized){if(this.tracker.debug)throw new Error("The initialized statement for the specified id has already been sent!");return console.warn("The initialized statement for the specified id has already been sent!"),void(e=!1)}if(e&&(this.initializedTime=new Date,this.initialized=!0),this.type!=I.SCO)throw new Error("You cannot initialize an object for a type different that SCO.");return this.tracker.Trace("initialized",this.ScormType[this.type],this.scormId)}Suspended(){if(!this.initialized){if(this.tracker.debug)throw new Error("You need to send a initialized statement before sending an suspended statement!");return void console.warn("You need to send a initialized statement before sending an suspended statement!")}let e=new Date;if(this.initialized=!1,this.type!=I.SCO)throw new Error("You cannot suspend an object for a type different that SCO.");return this.tracker.Trace("suspended",this.ScormType[this.type],this.scormId).withDuration(this.initializedTime,e)}Resumed(){var e=!0;if(this.initialized){if(this.tracker.debug)throw new Error("The Resumed statement for the specified id has already been sent!");return console.warn("The Resumed statement for the specified id has already been sent!"),void(e=!1)}if(e&&(this.initializedTime=new Date,this.initialized=!0),this.type!=I.SCO)throw new Error("You cannot resume an object for a type different that SCO.");return this.tracker.Trace("resumed",this.ScormType[this.type],this.scormId)}Terminated(){if(!this.initialized){if(this.tracker.debug)throw new Error("You need to send a initialized statement before sending an Terminated statement!");return void console.warn("You need to send a initialized statement before sending an Terminated statement!")}let e=new Date;if(this.initialized=!1,this.type!=I.SCO)throw new Error("You cannot terminate an object for a type different that SCO.");return this.tracker.Trace("terminated",this.ScormType[this.type],this.scormId).withDuration(this.initializedTime,e)}Passed(){return this.tracker.Trace("passed",this.ScormType[this.type],this.scormId)}Failed(){return this.tracker.Trace("failed",this.ScormType[this.type],this.scormId)}Scored(e){return void 0===e&&(e=1),this.tracker.Trace("scored",this.ScormType[this.type],this.scormId).withScore({raw:e})}Completed(e,t,s){if(void 0===e&&(e=!0),void 0===t&&(t=!1),void 0===s&&(s=1),!this.initialized){if(this.tracker.debug)throw new Error("You need to send a initialized statement before sending an suspended statement!");return void console.warn("You need to send a initialized statement before sending an suspended statement!")}let i=new Date;return this.tracker.Trace("completed",this.ScormType[this.type],this.scormId).withSuccess(e).withCompletion(t).withScore({raw:s}).withDuration(this.initializedTime,i)}}const I=Object.freeze({SCO:0,COURSE:1,MODULE:2,ASSESSMENT:3,INTERACTION:4,OBJECTIVE:5,ATTEMPT:6});class A{tracker;constructor({result_uri:e=null,backup_uri:t=null,backup_type:s=null,actor_homePage:i=null,actor_name:n=null,auth_token:a=null,default_uri:r=null,debug:o=null}={}){this.tracker=new m({endpoint:e,backup_endpoint:t,backup_type:s,actor_homePage:i,actor_name:n,auth_token:a,default_uri:r,debug:o})}flush({withBackup:e=!1}={}){return this.tracker.flush({withBackup:e})}generateXAPITrackerFromURLParams({default_uri:e=null}={}){const t={},s=new URLSearchParams(window.location.search);let i,n,a,r,o,h,c,l,u,d,p,y,f;if(s.size>0){i=s.get("result_uri"),n=s.get("backup_uri"),a=s.get("backup_type"),o=s.get("actor_homePage"),r=s.get("actor_user");const e=s.get("sso_token_endpoint");e&&(t.token_endpoint=e);const m=s.get("sso_client_id");m&&(t.client_id=m);const g=s.get("sso_login_hint");g&&(t.login_hint=g);const b=s.get("sso_grant_type");b&&(t.grant_type=b);const w=s.get("sso_scope");w&&(t.scope=w);const k=s.get("sso_username");k&&(t.username=k);const _=s.get("sso_password");_?t.password=_:k&&(t.password=k),l=s.get("username"),u=s.get("password"),d=s.get("auth_token"),h=s.get("debug"),p=parseInt(s.get("batch_length")),y=parseInt(s.get("batch_timeout")),f=parseInt(s.get("max_retry_delay")),null!==h&&"true"===h&&(c=Boolean(h),console.debug(i),console.debug(a),console.debug(r),console.debug(o),console.debug(c),console.debug(p),console.debug(y),console.debug(f))}else i=null,a="XAPI",o=null,r=null,c=!1;t.token_endpoint?this.tracker=new b({endpoint:i,backup_endpoint:n,backup_type:a,actor_homePage:o,actor_name:r,config:t,default_uri:e,debug:c,batchLength:p,batchTimeout:y,maxRetryDelay:f}):this.tracker=l&&u?new g({endpoint:i,backup_endpoint:n,backup_type:a,actor_homePage:o,actor_name:r,username:l,password:u,default_uri:e,debug:c,batchLength:p,batchTimeout:y,maxRetryDelay:f}):new m({endpoint:i,backup_endpoint:n,backup_type:a,actor_homePage:o,actor_name:r,auth_token:d,default_uri:e,debug:c,batchLength:p,batchTimeout:y,maxRetryDelay:f})}}class R extends A{SCORMTYPE=I;scormInstances={};scorm(e,t=I.SCO){var s;this.scormInstances[t]||(this.scormInstances[t]={}),this.scormInstances[t][e]?s=this.scormInstances[t][e]:(s=new E(this.tracker,e,t),this.scormInstances[t][e]=s)}}class P extends A{ACCESSIBLETYPE=w;COMPLETABLETYPE=_;ALTERNATIVETYPE=S;GAMEOBJECTTYPE=v;scormTracker;instances={completable:{},gameObject:{},alternative:{},accessible:{}};constructor({result_uri:e=null,backup_uri:t=null,activityId:s=null,backup_type:i=null,actor_homePage:n=null,actor_name:a=null,auth_token:r=null,default_uri:o=null,debug:h=null}={}){super({result_uri:e,backup_uri:t,backup_type:i,actor_homePage:n,actor_name:a,auth_token:r,default_uri:o,debug:h}),this.scormTracker=new E(this.tracker,s,I.SCO)}start(){return this.scormTracker.Initialized()}pause(){return this.scormTracker.Suspended()}resumed(){return this.scormTracker.Resumed()}finish(){return this.scormTracker.Terminated()}accessible(e,t=w.ACCESSIBLE){var s;return this.instances.accessible[t]||(this.instances.accessible[t]={}),this.instances.accessible[t][e]?s=this.instances.accessible[t][e]:(s=new f(this.tracker,e,t),this.instances.accessible[t][e]=s),s}gameObject(e,t=v.GAMEOBJECT){var s;return this.instances.gameObject[t]||(this.instances.gameObject[t]={}),this.instances.gameObject[t][e]?s=this.instances.gameObject[t][e]:(s=new T(this.tracker,e,t),this.instances.gameObject[t][e]=s),s}completable(e,t=_.COMPLETABLE){var s;return this.instances.completable[t]||(this.instances.completable[t]={}),this.instances.completable[t][e]?s=this.instances.completable[t][e]:(s=new k(this.tracker,e,t),this.instances.completable[t][e]=s),s}alternative(e,t=S.ALTERNATIVE){var s;return this.instances.alternative[t]||(this.instances.alternative[t]={}),this.instances.alternative[t][e]?s=this.instances.alternative[t][e]:(s=new x(this.tracker,e,t),this.instances.alternative[t][e]=s),s}}export{R as JSScormTracker,A as JSTracker,P as SeriousGameTracker};
