import t from"@xapi/xapi";import{v4 as e}from"uuid";import s from"axios";import i from"ms";class r{constructor(t,e){this.accountName=t,this.homepage=e}accountName;homepage;toXAPI(){return{account:{name:this.accountName,homePage:this.homepage}}}toCSV(){return this.accountName.replaceAll(",","\\,")}}class n{constructor(t="seriousgame",s=null){this.registration=null!=s?s:e(),this.categoryId=this.categoryIDs[t],this.category=t}registration;categoryIDs={seriousgame:"https://w3id.org/xapi/seriousgame",scorm:"https://w3id.org/xapi/scorm"};toXAPI(){return{registration:this.registration,contextActivities:{category:[{id:this.categoryId,definition:{type:"http://adlnet.gov/expapi/activities/profile"}}]}}}toCSV(){return this.registration.replaceAll(",","\\,")}}class o{constructor(t){this.verbId=this.verbIds[t],this.verbDisplay=t}verbIds={initialized:"http://adlnet.gov/expapi/verbs/initialized",progressed:"http://adlnet.gov/expapi/verbs/progressed",completed:"http://adlnet.gov/expapi/verbs/completed",accessed:"https://w3id.org/xapi/seriousgames/verbs/accessed",skipped:"http://id.tincanapi.com/verb/skipped",selected:"https://w3id.org/xapi/adb/verbs/selected",unlocked:"https://w3id.org/xapi/seriousgames/verbs/unlocked",interacted:"http://adlnet.gov/expapi/verbs/interacted",used:"https://w3id.org/xapi/seriousgames/verbs/used",responded:"http://adlnet.gov/expapi/verbs/responded",resumed:"http://adlnet.gov/expapi/verbs/resumed",suspended:"http://adlnet.gov/expapi/verbs/suspended",terminated:"http://adlnet.gov/expapi/verbs/resumed",passed:"http://adlnet.gov/expapi/verbs/passed",failed:"http://adlnet.gov/expapi/verbs/failed",scored:"http://adlnet.gov/expapi/verbs/scored"};verbId;verbDisplay;toXAPI(){var t={};return this.verbId&&(t.id=this.verbId),this.verbDisplay&&(t.display={en:this.verbDisplay}),t}toCSV(){return this.verbId}}class a{constructor(t,e,s=null,i=null){this.id=t,this.type=e,this.name=s,this.description=i}typeIds={game:"https://w3id.org/xapi/seriousgames/activity-types/serious-game",session:"https://w3id.org/xapi/seriousgames/activity-types/session",level:"https://w3id.org/xapi/seriousgames/activity-types/level",quest:"https://w3id.org/xapi/seriousgames/activity-types/quest",stage:"https://w3id.org/xapi/seriousgames/activity-types/stage",combat:"https://w3id.org/xapi/seriousgames/activity-types/combat",storynode:"https://w3id.org/xapi/seriousgames/activity-types/story-node",race:"https://w3id.org/xapi/seriousgames/activity-types/race",completable:"https://w3id.org/xapi/seriousgames/activity-types/completable",screen:"https://w3id.org/xapi/seriousgames/activity-types/screen",area:"https://w3id.org/xapi/seriousgames/activity-types/area",zone:"https://w3id.org/xapi/seriousgames/activity-types/zone",cutscene:"https://w3id.org/xapi/seriousgames/activity-types/cutscene",accessible:"https://w3id.org/xapi/seriousgames/activity-types/accessible",question:"http://adlnet.gov/expapi/activities/question",menu:"https://w3id.org/xapi/seriousgames/activity-types/menu",dialog:"https://w3id.org/xapi/seriousgames/activity-types/dialog-tree",path:"https://w3id.org/xapi/seriousgames/activity-types/path",arena:"https://w3id.org/xapi/seriousgames/activity-types/arena",alternative:"https://w3id.org/xapi/seriousgames/activity-types/alternative",enemy:"https://w3id.org/xapi/seriousgames/activity-types/enemy",npc:"https://w3id.org/xapi/seriousgames/activity-types/non-player-character",item:"https://w3id.org/xapi/seriousgames/activity-types/item",gameobject:"https://w3id.org/xapi/seriousgames/activity-types/game-object",course:"http://adlnet.gov/expapi/activities/course",module:"http://adlnet.gov/expapi/activities/module",SCO:"http://adlnet.gov/expapi/activities/lesson",assessment:"http://adlnet.gov/expapi/activities/assessment",interaction:"http://adlnet.gov/expapi/activities/interaction",cmi_interaction:"http://adlnet.gov/expapi/activities/cmi.interaction",objective:"http://adlnet.gov/expapi/activities/objective",attempt:"http://adlnet.gov/expapi/activities/attempt",profile:"http://adlnet.gov/expapi/activities/profile"};ExtensionIDs={extended_interaction_type:"https://w3id.org/xapi/netc-assessment/extensions/activity/extended-interaction-type"};id;type;name;description;toXAPI(){var t={};return this.id&&(t.id=this.id),t.definition={},this.name&&(t.definition.name={"en-US":this.name}),this.description&&(t.definition.description={"en-US":this.description}),this.type&&(t.definition.type=this.typeIds[this.type]),t}toCSV(){return this.typeIds[this.type].replaceAll(",","\\,")+","+this.id.replaceAll(",","\\,")}}class h{constructor(t){this.defautURI=t,this.Score=null,this.Success=null,this.Completion=null,this.Response=null,this.Duration=null,this.Extensions={}}defautURI;Score;Success;Completion;Response;Duration;Extensions;isEmpty(){return null==this.Score&&null==this.Duration&&null==this.Success&&null==this.Completion&&null==this.Response&&0==Object.keys(this.Extensions).length}ExtensionIDs={health:"https://w3id.org/xapi/seriousgames/extensions/health",position:"https://w3id.org/xapi/seriousgames/extensions/position",progress:"https://w3id.org/xapi/seriousgames/extensions/progress",interactionID:"https://w3id.org/xapi/netc-assessment/extensions/activity/id-number",response_explanation:"https://w3id.org/xapi/netc-assessment/extensions/result/response-explanation",response_type:"https://w3id.org/xapi/netc-assessment/extensions/result/response-type"};ScoreKey=["raw","min","max","scaled"];setExtensions(t){for(var e in this.Extensions={},t)this.setExtension(e,t[e])}setExtension(t,e){switch(t.toLowerCase()){case"success":this.Success=e;break;case"completion":this.Completion=e;break;case"response":this.Response=e;break;case"score":this.Score=this.setScoreValue("raw",e);break;case"duration":this.Duration=e;break;default:this.Extensions[t]=e}}setAsUri(t){return this.isUri(t)?t:`${this.defautURI}://${t}`}isUri(t){return/^[a-zA-Z][a-zA-Z\d+\-.]*:\/\/[^\s/$.?#].[^\s]*$/i.test(t)}setScoreValue(t,e){this.Score||(this.Score={}),this.ScoreKey.includes(t)&&(this.Score[t]=Number(e))}toXAPI(){var t={};if(null!==this.Success&&(t.success=!!this.Success),null!==this.Completion&&(t.completion=!!this.Completion),this.Response&&(t.response=this.Response.toString()),null!==this.Score&&(t.score=this.Score),null!==this.Duration&&(t.duration=this.Duration),null!==this.Extensions&&c(this.Extensions)>0)for(var e in t.extensions=this.Extensions,this.Extensions)if(this.ExtensionIDs.hasOwnProperty(e))this.Extensions[this.ExtensionIDs[e]]=this.Extensions[e],delete this.Extensions[e];else{var s=this.setAsUri(e);this.Extensions[s]=this.Extensions[e],s!==e&&delete this.Extensions[e]}return t}toCSV(){var t=null!==this.Success?",success,"+this.Success.toString():"",e=null!==this.Completion?",completion,"+this.Completion.toString():"",s=this.Response?",response,"+this.Response.replaceAll(",","\\,"):"",i="";l(this.Score)&&(l(this.Score.raw)&&(i+=",score,"+this.Score.raw),l(this.Score.min)&&(i+=",score_min,"+this.Score.min),l(this.Score.max)&&(i+=",score_max,"+this.Score.max),l(this.Score.scaled)&&(i+=",score_scaled,"+this.Score.scaled));var r=t+e+s+i;if(null!==this.Extensions&&c(this.Extensions)>0)for(var n in this.Extensions)if(r+=","+n.replaceAll(",","\\,")+",",null!==this.Extensions[n])if("number"==typeof this.Extensions[n])r+=this.Extensions[n];else if("string"==typeof this.Extensions[n])r+=this.Extensions[n].replaceAll(",","\\,");else if("object"==typeof this.Extensions[n]){if(u(this.Extensions[n])){var o="";for(var a in this.Extensions[n])"number"==typeof this.Extensions[n][a]?o+=a+"="+this.Extensions[n][a]+"-":o+=a+"="+this.Extensions[n][a].replaceAll(",","\\,")+"-";r+=o.slice(0,-1)}}else r+=this.Extensions[n];return r}}var c=function(t){var e,s=0;for(e in t)t.hasOwnProperty(e)&&s++;return s},u=function(t){for(var e in t)if("object"==typeof t[e])return!1;return!0},l=function(t){return!(null==t)};class p{constructor(t,s,i,r,n,c){this.id=e(),this.actor=t,this.verb=new o(s),this.defaultURI=c,this.object=new a(this.setAsUri(i),r),this.timestamp=new Date,this.context=n,this.version="1.0.3",this.result=new h(this.defaultURI)}id;version;defaultURI;actor;verb;object;timestamp;context;result;setAsUri(t){return this.isUri(t)?t:`${this.defaultURI}://${t}`}isUri(t){return/^[a-zA-Z][a-zA-Z\d+\-.]*:\/\/[^\s/$.?#].[^\s]*$/i.test(t)}setScore(t,e,s,i){t&&this.setScoreRaw(t),e&&this.setScoreMin(e),s&&this.setScoreMax(s),i&&this.setScoreScaled(i)}setScoreRaw(t){this.result.setScoreValue("raw",t)}setScoreMin(t){this.result.setScoreValue("min",t)}setScoreMax(t){this.result.setScoreValue("max",t)}setScoreScaled(t){this.result.setScoreValue("scaled",t)}setCompletion(t){this.addResultExtension("completion",t)}setSuccess(t){this.addResultExtension("success",t)}setDuration(t){const e=t%60,s=Math.floor(t/60)%60,i=Math.floor(t/3600)%24,r=`P${Math.floor(t/86400)}DT${i}H${s}M${e}S`;this.addResultExtension("duration",r)}setResponse(t){this.addResultExtension("response",t)}setProgress(t){this.addResultExtension("progress",t)}setVar(t,e){this.addResultExtension(t,e)}addResultExtension(t,e){this.result.setExtension(t,e)}addResultExtensions(t){this.result.setExtensions(t)}toXAPI(){var t={};return this.id&&(t.id=this.id),this.actor&&(t.actor=this.actor.toXAPI()),this.verb&&(t.verb=this.verb.toXAPI()),this.object&&(t.object=this.object.toXAPI()),this.timestamp&&(t.timestamp=this.timestamp.toISOString()),this.context&&(t.context=this.context.toXAPI()),this.version&&(t.version=this.version),this.result.isEmpty()||(t.result=this.result.toXAPI()),t}toCSV(){var t=[];t.push(this.timestamp.toISOString()),t.push(this.verb.toCSV()),t.push(this.object.toCSV());var e="";return this.result.isEmpty()||(e=this.result.toCSV()),`${t.join(",")}${e}`}}class d{client;statement;_promise;constructor(t,e){this.client=t,this.statement=e,this._promise=Promise.resolve().then((()=>this.client.enqueue(this.statement)))}withSuccess(t){return this.statement.setSuccess(t),this}withScore(t){return this.statement.setScore(t.raw??t?.raw,t.min??t?.min,t.max??t?.max,t.scaled??t?.scaled),this}withScoreRaw(t){return this.statement.setScoreRaw(t),this}withScoreMin(t){return this.statement.setScoreMin(t),this}withScoreMax(t){return this.statement.setScoreMax(t),this}withScoreScaled(t){return this.statement.setScoreScaled(t),this}withCompletion(t){return this.statement.setCompletion(t),this}withDuration(t){return this.statement.setDuration(t),this}withResponse(t){return this.statement.setResponse(t),this}withProgress(t){return this.statement.setProgress(t),this}withResultExtension(t,e){return this.statement.addResultExtension(t,e),this}withResultExtensions(t={}){return this.statement.addResultExtensions(t),this}apply(t){const e=t(this.statement);return e instanceof p&&(this.statement=e),this}then(t,e){return this._promise.then(t,e)}catch(t){return this._promise.catch(t)}finally(t){return this._promise.finally(t)}}class m{xapi=null;endpoint;auth_token=null;online=!1;statementsToSend=[];sendingInProgress=!1;offset=0;backup=!1;backup_endpoint=null;backup_type=null;backupRequestParameters=null;actor;actor_homePage;actor_name;context;default_uri;debug;batchlength;batchtimeout;retryDelay=null;maxRetryDelay;timer=null;constructor(t,e,s,o,a,h,c,u,l,p,d){this.default_uri=c,this.debug=u,this.online=!1,this.endpoint=t,e&&(this.backup=!0,null==s&&(s="CSV"),this.backup_type=s,this.backup_endpoint=e),this.batchlength="string"==typeof l?parseInt(l):l||100,this.batchtimeout=i(p||"30sec"),this.offset=0,this.maxRetryDelay=i(d||"2min"),this.statementsToSend=[],this.timer=null,this.auth_token=h,this.actor_homePage=o,this.actor_name=a,this.actor=new r(this.actor_name,this.actor_homePage),this.context=new n,this.updateAuth()}logout(){this.auth_token=null,this.onOffline()}onOffline(){this.online=!1,this.debug&&console.warn("XAPI Tracker for Serious Games went offline")}async onOnline(){this.online=!0,this.debug&&console.info("XAPI Tracker for Serious Games back Online")}updateAuth(){null!=this.auth_token?(this.xapi=new t({endpoint:this.endpoint,auth:this.auth_token}),null!=this.xapi?this.onOnline():this.onOffline()):this.onOffline()}async sendBatch(){if(!this.online)return;if(this.offset>=this.statementsToSend.length)return;const t=Math.min(this.offset+this.batchlength,this.statementsToSend.length),e=this.statementsToSend.slice(this.offset,t),s=e.map((t=>t.toXAPI()));try{if(!this.sendingInProgress){this.sendingInProgress=!0;const t=await this.xapi.sendStatements({statements:s});this.sendingInProgress=!1,this.debug&&console.debug("Batch sent successfully:",t),this.offset+=e.length,this.retryDelay=null}}catch(t){console.error("Error sending batch:",t.response);const e=t.response.status,s=t.response.data.message||t.message;switch(e){case 401:case 403:console.error(`${401===e?"Unauthorized":"Forbidden"}: ${s}`),this.onOffline(),await this.refreshAuth(),this.sendingInProgress=!1,await this.sendBatch();break;default:console.error(`[TRACKER: Batch Processor] Batch upload returned status ${e} with message: ${s}`),this.sendingInProgress=!1,this.onOffline()}null==this.retryDelay&&(this.retryDelay=this.batchtimeout),this.retryDelay=Math.min(2*this.retryDelay,this.maxRetryDelay),this.timer=null}this.offset<this.statementsToSend.length&&this.startTimer()}async refreshAuth(){this.updateAuth()}startTimer(){if(this.timer)return;let t=this.retryDelay?this.retryDelay:this.batchtimeout;this.timer=setTimeout((async()=>{await this.sendBatch(),this.timer=null,this.offset<this.statementsToSend.length&&this.startTimer()}),t)}Trace(t,e,s){const i=new p(this.actor,t,s,e,this.context,this.default_uri);return new d(this,i)}async sendBackup(){if(this.online&&this.backup_endpoint&&this.backup_endpoint.trim()){let t,e;switch(this.backup_type){case"XAPI":e=this.statementsToSend.map((t=>JSON.stringify(t.toXAPI()))),t="application/json";break;case"CSV":e=this.statementsToSend.map((t=>t.toCSV())),t="text/csv";break;default:return}const i={tofile:!0,result:e.join("\n"),contentType:t},r={url:this.backup_endpoint,method:"POST",headers:{Authorization:this.auth_token||"","Content-Type":"application/json"},data:JSON.stringify(i,null,2)};if(this.backupRequestParameters&&(this.backupRequestParameters.content_type&&(r.headers["Content-Type"]=this.backupRequestParameters.content_type),this.backupRequestParameters.headers&&"object"==typeof this.backupRequestParameters.headers&&Object.entries(this.backupRequestParameters.headers).forEach((([t,e])=>{r.headers[t]=e})),this.backupRequestParameters.query_parameters&&"object"==typeof this.backupRequestParameters.query_parameters)){const t=new URLSearchParams(this.backupRequestParameters.query_parameters).toString();r.url+=`?${t}`}try{const t=await s(r);console.log(t)}catch(t){if(!t.response)throw new Error(`Request failed: ${t.message}`);{const e=t.response.status,s=t.response.data.message||t.message;switch(e){case 401:case 403:this.onOffline(),console.error(`${401===e?"Unauthorized":"Forbidden"}: ${s}`),await this.refreshAuth(),await this.sendBackup();break;default:console.error(`[TRACKER: Backup Processor] Backup upload returned status ${e} with message: ${s}`)}}}}}async enqueue(t){this.debug&&(console.debug(t.toXAPI()),console.debug(t.toCSV())),this.statementsToSend.push(t),this.online&&this.statementsToSend.length>=this.offset+this.batchlength&&await this.sendBatch(),this.startTimer()}async flush({withBackup:t=!1}={}){t?await Promise.all([this.sendBatch(),this.sendBackup()]):await this.sendBatch()}}class g extends m{constructor(e,s,i,r,n,o,a,h,c,u,l,p){super(e,s,i,r,n,t.toBasicAuth(o,a),h,c,u,l,p),window.addEventListener("beforeunload",(()=>{this.auth_token&&this.logout()}))}async refreshAuth(){super.refreshAuth()}logout(){super.logout()}}class y{fieldMissingMessage;unsupportedGrantTypeMessage;unsupportedCodeChallengeMethodMessage;authEndpoint=null;tokenEndpoint=null;grantType=null;username=null;password=null;clientId=null;scope=null;state=null;login_hint=null;codeChallengeMethod=null;token=null;tokenRefreshInProgress=!1;onAuthorizationInfoUpdate=null;constructor(){this.fieldMissingMessage='Field "{0}" required for "OAuth 2.0" authentication is missing!',this.unsupportedGrantTypeMessage='Grant type "{0}" not supported. Please use either "code" type or "password" type.',this.unsupportedCodeChallengeMethodMessage='Code challenge (PKCE) method "{0}" not supported. Please use "S256" method or disable it.'}async init(t){if(console.log("[OAuth2] Starting"),this.tokenEndpoint=this.getRequiredValue(t,"token_endpoint"),this.grantType=this.getRequiredValue(t,"grant_type").toLowerCase(),this.clientId=this.getRequiredValue(t,"client_id"),this.scope=t.scope||null,this.state=t.state||null,t.code_challenge_method){const e=t.code_challenge_method.toUpperCase();if("S256"!==e)throw new Error(this.unsupportedCodeChallengeMethodMessage.replace("{0}",e));this.codeChallengeMethod="S256"}switch(this.grantType){case"refresh_token":const e=this.getRequiredValue(t,"refresh_token");this.token=await this.doRefreshToken(this.tokenEndpoint,this.clientId,e);break;case"password":this.username=this.getRequiredValue(t,"username"),this.password=this.getRequiredValue(t,"password"),this.login_hint=this.getRequiredValue(t,"login_hint"),this.token=await this.doResourceOwnedPasswordCredentialsFlow(this.tokenEndpoint,this.clientId,this.username,this.password,this.login_hint,this.scope,this.state);break;default:throw new Error(this.unsupportedGrantTypeMessage.replace("{0}",this.grantType))}this.token&&console.log("[OAuth2] Token obtained: "+this.token.access_token)}getRequiredValue(t,e){if(!t[e])throw new Error(this.fieldMissingMessage.replace("{0}",e));return t[e]}async doResourceOwnedPasswordCredentialsFlow(t,e,s,i,r,n,o){const a={username:s,password:i,login_hint:r};return n&&(a.scope=n),o&&(a.state=o),await this.doTokenRequest(t,e,"password",a)}async doTokenRequest(t,e,s,i){const r={grant_type:s,client_id:e,...i};try{const e=await fetch(t,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams(r)});return await e.json()}catch(t){throw t.response&&t.response.data?new Error(t.response.data.error||"Error during token request"):t}}async doRefreshToken(t,e,s){return await this.doTokenRequest(t,e,"refresh_token",{refresh_token:s})}async refreshToken(){if(0==this.tokenRefreshInProgress)try{return this.tokenRefreshInProgress=!0,this.token=await this.doRefreshToken(this.tokenEndpoint,this.clientId,this.token.refresh_token),this.tokenRefreshInProgress=!1,this.token.access_token}catch(t){this.tokenRefreshInProgress=!1,console.error(t)}else for(;1==this.tokenRefreshInProgress;)await new Promise((t=>setTimeout(t,2e3)))}hasTokenExpired(){return new Date(this.token.requestTime.getTime()+1e3*this.token.expires_in)>new Date}async updateParamsForAuth(t){this.hasTokenExpired()&&(this.token=await this.doRefreshToken(this.tokenEndpoint,this.clientId,this.token.refresh_token),this.onAuthorizationInfoUpdate&&this.onAuthorizationInfoUpdate(this.token)),t.headers={...t.headers,Authorization:`${this.token.token_type.charAt(0).toUpperCase()+this.token.token_type.slice(1)} ${this.token.access_token}`}}registerAuthInfoUpdate(t){t&&(this.onAuthorizationInfoUpdate=t,this.token&&t(this.token))}async logout(){const t={grant_type:"refresh_token",client_id:this.clientId,refresh_token:this.token.refresh_token};try{const e=await fetch(this.tokenEndpoint.replace("/token","/logout"),{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams(t)}),s=await e.json();console.log(s),console.log("[OAuth2] Logged out successfully")}catch(t){throw t.response&&t.response.data?new Error(t.response.data.error||"[OAuth2] Error during logout"):t}}}class f extends m{oauth2Config;oauth2=null;constructor(t,e,s,i,r,n,o,a,h,c,u){super(t,e,s,i,r,null,o,a,h,c,u),this.oauth2Config=n,this.oauth2=null,this.initAuth(),window.addEventListener("beforeunload",(()=>{this.auth_token&&this.logout()}))}async getToken(){try{return this.oauth2=new y,await this.oauth2.init(this.oauth2Config),this.oauth2.token.access_token}catch(t){return console.error(t),null}}async initAuth(){const t=await this.getToken();null!==t&&(this.auth_token="Bearer "+t,console.debug(this.auth_token),this.updateAuth())}async refreshAuth(){const t=await this.oauth2.refreshToken();t&&(this.auth_token="Bearer "+t,console.debug(this.auth_token),this.updateAuth())}updateAuth(){super.updateAuth()}async logout(){await this.oauth2.logout(),super.logout()}}class w{constructor(t,e,s=4){this.accessibleId=e,this.type=s,this.tracker=t}accessibleId;type;tracker;AccessibleType=["screen","area","zone","cutscene","accessible"];Accessed(){return this.tracker.Trace("accessed",this.AccessibleType[this.type],this.accessibleId)}Skipped(){return this.tracker.Trace("skipped",this.AccessibleType[this.type],this.accessibleId)}}const k=Object.freeze({SCREEN:0,AREA:1,ZONE:2,CUTSCENE:3,ACCESSIBLE:4});class b{constructor(t,e,s=8){this.completableId=e,this.type=s,this.tracker=t}completableId;type;tracker;CompletableType=["game","session","level","quest","stage","combat","storynode","race","completable"];Initialized(){return this.tracker.Trace("initialized",this.CompletableType[this.type],this.completableId)}Progressed(t){return this.tracker.Trace("progressed",this.CompletableType[this.type],this.completableId).withProgress(t)}Completed(t,e,s){return void 0===t&&(t=!0),void 0===e&&(e=!1),void 0===s&&(s=1),this.tracker.Trace("completed",this.CompletableType[this.type],this.completableId).withSuccess(t).withCompletion(e).withScore({raw:s})}}const x=Object.freeze({GAME:0,SESSION:1,LEVEL:2,QUEST:3,STAGE:4,COMBAT:5,STORYNODE:6,RACE:7,COMPLETABLE:8});class S{constructor(t,e,s=5){this.alternativeId=e,this.type=s,this.tracker=t}alternativeId;type;tracker;AlternativeType=["question","menu","dialog","path","arena","alternative"];Selected(t){return this.tracker.Trace("selected",this.AlternativeType[this.type],this.alternativeId).withResponse(t)}Unlocked(t){return this.tracker.Trace("unlocked",this.AlternativeType[this.type],this.alternativeId).withResponse(t)}}const v=Object.freeze({QUESTION:0,MENU:1,DIALOG:2,PATH:3,ARENA:4,ALTERNATIVE:5});class E{constructor(t,e,s=3){this.gameobjectId=e,this.type=s,this.tracker=t}gameobjectId;type;tracker;GameObjectType=["enemy","npc","item","gameobject"];Interacted(){return this.tracker.Trace("interacted",this.GameObjectType[this.type],this.gameobjectId)}Used(){return this.tracker.Trace("used",this.GameObjectType[this.type],this.gameobjectId)}}const T=Object.freeze({ENEMY:0,NPC:1,ITEM:2,GAMEOBJECT:3});class _{constructor(t,e,s=0){this.scormId=e,this.type=s,this.tracker=t}accessibleId;type;tracker;ScormType=["SCO","course","module","assessment","interaction","objective","attempt"];Initialized(){if(0!=this.type)throw new Error("You cannot initialize an object for a type different that SCO.");return this.tracker.Trace("initialized",this.ScormType[this.type],this.scormId)}Suspended(){if(0!=this.type)throw new Error("You cannot suspend an object for a type different that SCO.");return this.tracker.Trace("suspended",this.ScormType[this.type],this.scormId)}Resumed(){if(0!=this.type)throw new Error("You cannot resume an object for a type different that SCO.");return this.tracker.Trace("resumed",this.ScormType[this.type],this.scormId)}Terminated(){if(0!=this.type)throw new Error("You cannot terminate an object for a type different that SCO.");return this.tracker.Trace("terminated",this.ScormType[this.type],this.scormId)}Passed(){return this.tracker.Trace("passed",this.ScormType[this.type],this.scormId)}Failed(){return this.tracker.Trace("failed",this.ScormType[this.type],this.scormId)}Scored(t){return void 0===t&&(t=1),this.tracker.Trace("scored",this.ScormType[this.type],this.scormId).withScore({raw:t})}Completed(t,e,s){return void 0===t&&(t=!0),void 0===e&&(e=!1),void 0===s&&(s=1),this.tracker.Trace("completed",this.ScormType[this.type],this.scormId).withSuccess(t).withCompletion(e).withScore({raw:s})}}const I=Object.freeze({SCO:0,COURSE:1,MODULE:2,ASSESSMENT:3,INTERACTION:4,OBJECTIVE:5,ATTEMPT:6});class A{tracker;constructor({result_uri:t=null,backup_uri:e=null,backup_type:s=null,actor_homepage:i=null,actor_username:r=null,auth_token:n=null,default_uri:o=null,debug:a=null}={}){this.tracker=new m(t,e,s,i,r,n,o,a)}flush({withBackup:t=!1}={}){return this.tracker.flush({withBackup:t})}generateXAPITrackerFromURLParams({default_uri:t=null}={}){const e={},s=new URLSearchParams(window.location.search);let i,r,n,o,a,h,c,u,l,p,d,y;if(s.size>0){i=s.get("result_uri"),r=s.get("backup_uri"),n=s.get("backup_type"),a=s.get("actor_homepage"),o=s.get("actor_user");const t=s.get("sso_token_endpoint");t&&(e.token_endpoint=t);const m=s.get("sso_client_id");m&&(e.client_id=m);const g=s.get("sso_login_hint");g&&(e.login_hint=g);const f=s.get("sso_grant_type");f&&(e.grant_type=f);const w=s.get("sso_scope");w&&(e.scope=w);const k=s.get("sso_username");k&&(e.username=k);const b=s.get("sso_password");b?e.password=b:k&&(e.password=k),c=s.get("username"),u=s.get("password"),l=s.get("auth_token"),h=s.get("debug"),p=s.get("batch_length"),d=s.get("batch_timeout"),y=s.get("max_retry_delay"),null!==h&&"true"===h&&(h=Boolean(h),console.debug(i),console.debug(n),console.debug(o),console.debug(a),console.debug(h),console.debug(p),console.debug(d),console.debug(y))}else i=null,n="XAPI",a=null,o=null,h=!1;e.token_endpoint?this.tracker=new f(i,r,n,a,o,e,t,h,p,d,y):this.tracker=c&&u?new g(i,r,n,a,o,c,u,t,h,p,d,y):new m(i,r,n,a,o,l,t,h,p,d,y)}}class R extends A{SCORMTYPE=I;scorm(t,e){return new _(this.tracker,t,e)}}class C extends A{ACCESSIBLETYPE=k;COMPLETABLETYPE=x;ALTERNATIVETYPE=v;GAMEOBJECTTYPE=T;scormTracker;constructor({result_uri:t=null,backup_uri:e=null,activityId:s=null,backup_type:i=null,actor_homepage:r=null,actor_username:n=null,auth_token:o=null,default_uri:a=null,debug:h=null}={}){super({result_uri:t,backup_uri:e,backup_type:i,actor_homepage:r,actor_username:n,auth_token:o,default_uri:a,debug:h}),this.scormTracker=new _(this.tracker,s,I.SCO)}start(){return this.scormTracker.Initialized()}pause(){return this.scormTracker.Suspended()}resumed(){return this.scormTracker.Resumed()}finish(){return this.scormTracker.Terminated()}accesible(t,e){return new w(this.tracker,t,e)}gameObject(t,e){return new E(this.tracker,t,e)}completable(t,e){return new b(this.tracker,t,e)}alternative(t,e){return new S(this.tracker,t,e)}}export{R as JSScormTracker,A as JSTracker,C as SeriousGameTracker};
